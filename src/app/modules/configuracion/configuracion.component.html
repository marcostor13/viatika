<div class="p-6">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Configuraci√≥n</h1>
    <p class="text-gray-600">
      Gestiona las categor√≠as y proyectos de tu empresa
    </p>
  </div>

  @if (loading) {
  <div class="flex justify-center items-center py-8">
    <div
      class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
    ></div>
  </div>
  } @if (!loading) {
  <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold text-gray-900">
        Configuraci√≥n de Empresa
      </h2>
      @if (!showCompanyForm) {
      <app-button
        label="Editar Empresa"
        variant="primary"
        size="md"
        (clicked)="editCompanyConfig()"
      />
      }
    </div>

    @if (!showCompanyForm) {
    <div class="flex items-center space-x-6">
      @if (companyConfig?.logo) {
      <img
        [src]="companyConfig?.logo || ''"
        alt="Logo de la empresa"
        class="w-20 h-20 rounded-lg object-cover border-2 border-gray-200"
        onerror="this.style.display='none'"
      />
      }
      <div>
        <h3 class="text-lg font-medium text-gray-900">
          {{ companyConfig?.businessName || "Mi Empresa" }}
        </h3>
        <p class="text-gray-500">Configuraci√≥n general de la empresa</p>
      </div>
    </div>
    } @if (showCompanyForm) {
    <div class="space-y-6">
      <div>
        <label
          for="companyName"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Nombre de la empresa
        </label>
        <input
          id="companyName"
          type="text"
          [(ngModel)]="companyName"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          placeholder="Ingresa el nombre de la empresa"
        />
      </div>

      <div>
        <label
          for="companyLogo"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Logo de la empresa
        </label>
        <div class="flex items-center space-x-4">
          @if (logoPreview || companyConfig?.logo) {
          <img
            [src]="logoPreview || companyConfig?.logo"
            alt="Preview del logo"
            class="w-16 h-16 rounded-lg object-cover border-2 border-gray-200"
          />
          }
          <div class="flex-1">
            <input
              id="companyLogo"
              type="file"
              accept="image/*"
              (change)="onLogoSelected($event)"
              [disabled]="isUploadingLogo"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 disabled:opacity-50"
            />
            <p class="text-xs text-gray-500 mt-1">
              Formatos: JPG, PNG, GIF. M√°ximo 2MB
            </p>

            @if (isUploadingLogo) {
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-purple-600 h-2 rounded-full transition-all duration-300"
                  [style.width.%]="logoUploadProgress"
                ></div>
              </div>
              <p class="text-xs text-gray-600 mt-1">
                Subiendo logo... {{ logoUploadProgress }}%
              </p>
            </div>
            }
          </div>
        </div>
      </div>

      <div class="flex space-x-3">
        <app-button
          [label]="isUploadingLogo ? 'Guardando...' : 'Guardar Cambios'"
          variant="primary"
          size="md"
          [disabled]="isUploadingLogo"
          (clicked)="saveCompanyConfig()"
        >
          @if (isUploadingLogo) {
          <svg
            class="animate-spin -ml-1 mr-2 h-4 w-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          }
        </app-button>
        <app-button
          label="Cancelar"
          variant="secondary"
          size="md"
          [disabled]="isUploadingLogo"
          (clicked)="cancelCompanyEdit()"
        />
      </div>
    </div>
    }
  </section>

  <section class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold text-gray-900">
        Configuraci√≥n de SUNAT
      </h2>
      @if (!showSunatForm) {
      <app-button
        [label]="(sunatConfig ? 'Editar' : 'Configurar') + ' SUNAT'"
        variant="primary"
        size="md"
        (clicked)="editSunatConfig()"
      />
      }
    </div>

    @if (!showSunatForm) {
    <div class="space-y-4">
      @if (sunatConfig) {
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center"
        >
          <span class="text-orange-600 text-xl">üîß</span>
        </div>
        <div>
          <h3 class="text-lg font-medium text-gray-900">
            Configuraci√≥n SUNAT Activa
          </h3>
          <p class="text-gray-500">
            Client ID: {{ sunatConfig.clientIdSunat | mask : "00000000000" }}
          </p>
          <p class="text-gray-500">
            Estado:
            <span
              [class]="sunatConfig.isActive ? 'text-green-600' : 'text-red-600'"
            >
              {{ sunatConfig.isActive ? "Activo" : "Inactivo" }}
            </span>
          </p>
        </div>
      </div>
      } @else {
      <div class="text-center py-6 text-gray-500">
        <div
          class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4"
        >
          <span class="text-gray-400 text-2xl">üîß</span>
        </div>
        <p class="font-medium">No hay configuraci√≥n de SUNAT</p>
        <p class="text-sm">
          Configura las credenciales para validar comprobantes
        </p>
      </div>
      }       @if (sunatConfig) {
      <div class="flex space-x-3">
        <app-button
          label="Probar Conexi√≥n"
          variant="primary"
          size="md"
          (clicked)="testSunatConnection()"
        />
        <app-button
          label="Eliminar Configuraci√≥n"
          variant="danger"
          size="md"
          (clicked)="deleteSunatConfig()"
        />
      </div>
      }
    </div>
    } @if (showSunatForm) {
    <div class="space-y-6">
      <div>
        <label
          for="clientId"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Client ID
        </label>
        <input
          id="clientId"
          type="text"
          [(ngModel)]="sunatForm.clientIdSunat"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
          placeholder="Ingresa el Client ID de SUNAT"
        />
      </div>

      <div>
        <label
          for="clientSecret"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Client Secret
        </label>
        <input
          id="clientSecret"
          type="password"
          [(ngModel)]="sunatForm.clientSecret"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
          placeholder="Ingresa el Client Secret de SUNAT"
        />
      </div>

      <div>
        <label for="ruc" class="block text-sm font-medium text-gray-700 mb-2">
          RUC
        </label>
        <input
          id="ruc"
          type="text"
          [(ngModel)]="sunatForm.ruc"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
          placeholder="Ingresa el RUC de SUNAT"
        />
      </div>

      <div class="flex items-center">
        <input
          id="isActive"
          type="checkbox"
          [(ngModel)]="sunatForm.isActive"
          class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
        />
        <label for="isActive" class="ml-2 block text-sm text-gray-900">
          Activar configuraci√≥n
        </label>
      </div>

      <div class="flex space-x-3">
        <app-button
          label="Guardar Configuraci√≥n"
          variant="primary"
          size="md"
          (clicked)="saveSunatConfig()"
        />
        <app-button
          label="Cancelar"
          variant="secondary"
          size="md"
          (clicked)="cancelSunatEdit()"
        />
      </div>
    </div>
    }
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <section class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Categor√≠as</h2>
        @if (!showCategoryForm) {
        <app-button
          label="Agregar Categor√≠a"
          variant="primary"
          size="md"
          (clicked)="addCategory()"
        />
        }
      </div>

      @if (showCategoryForm) {
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-lg font-medium mb-4">
          {{ editingCategory ? "Editar" : "Nueva" }} Categor√≠a
        </h3>
        <div class="space-y-4">
          <div>
            <label
              for="categoryName"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Nombre de la categor√≠a
            </label>
            <input
              id="categoryName"
              type="text"
              [(ngModel)]="newCategory.name"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Ingresa el nombre de la categor√≠a"
            />
          </div>
          <div class="flex space-x-3">
            <app-button
              [label]="editingCategory ? 'Actualizar' : 'Guardar'"
              variant="primary"
              size="md"
              (clicked)="save()"
            />
            <app-button
              label="Cancelar"
              variant="secondary"
              size="md"
              (clicked)="cancelCategoryEdit()"
            />
          </div>
        </div>
      </div>
      }

      <div class="space-y-3">
        @for (category of categories; track category._id) {
        <div
          class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200"
        >
          <div class="flex items-center">
            <span class="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>
            <span class="font-medium text-gray-900">{{ category.name }}</span>
          </div>
          <div class="flex space-x-2">
            <button
              (click)="editCategory(category)"
              class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"
              title="Editar categor√≠a"
            >
              ‚úèÔ∏è
            </button>
            <button
              (click)="deleteCategory(category)"
              class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors duration-200"
              title="Eliminar categor√≠a"
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
        } @if (categories.length === 0) {
        <div class="text-center py-8 text-gray-500">
          <p>No hay categor√≠as registradas</p>
          <p class="text-sm">
            Haz clic en "Agregar Categor√≠a" para crear la primera
          </p>
        </div>
        }
      </div>
    </section>

    <section class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Proyectos</h2>
        @if (!showProjectForm) {
        <app-button
          label="Agregar Proyecto"
          variant="primary"
          size="md"
          (clicked)="addProject()"
        />
        }
      </div>

      @if (showProjectForm) {
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-lg font-medium mb-4">
          {{ editingProject ? "Editar" : "Nuevo" }} Proyecto
        </h3>
        <div class="space-y-4">
          <div>
            <label
              for="projectName"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Nombre del proyecto
            </label>
            <input
              id="projectName"
              type="text"
              [(ngModel)]="newProject.name"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
              placeholder="Ingresa el nombre del proyecto"
            />
          </div>
          <div class="flex space-x-3">
            <app-button
              [label]="editingProject ? 'Actualizar' : 'Guardar'"
              variant="primary"
              size="md"
              (clicked)="saveProject()"
            />
            <app-button
              label="Cancelar"
              variant="secondary"
              size="md"
              (clicked)="cancelProjectEdit()"
            />
          </div>
        </div>
      </div>
      }

      <div class="space-y-3">
        @for (project of projects; track project._id) {
        <div
          class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200"
        >
          <div class="flex items-center">
            <span class="w-3 h-3 bg-green-500 rounded-full mr-3"></span>
            <span class="font-medium text-gray-900">{{ project.name }}</span>
          </div>
          <div class="flex space-x-2">
            <button
              (click)="editProject(project)"
              class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors duration-200"
              title="Editar proyecto"
            >
              ‚úèÔ∏è
            </button>
            <button
              (click)="deleteProject(project)"
              class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors duration-200"
              title="Eliminar proyecto"
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
        } @if (projects.length === 0) {
        <div class="text-center py-8 text-gray-500">
          <p>No hay proyectos registrados</p>
          <p class="text-sm">
            Haz clic en "Agregar Proyecto" para crear el primero
          </p>
        </div>
        }
      </div>
    </section>
  </div>
  }
</div>
