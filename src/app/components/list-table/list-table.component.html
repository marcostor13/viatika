<!-- ListTable Mobile-Optimized Card View -->
<div class="flex flex-col gap-4 pb-20">
  @for (item of data; track item._id) {
  <div
    class="bg-quaternary rounded-xl shadow-soft p-5 transition-all duration-300 border border-transparent hover:border-primary/10 hover:shadow-lg"
  >
    <!-- Card Header (Always Visible) -->
    <div
      (click)="toggleDetails($index)"
      class="flex items-center justify-between cursor-pointer"
    >
      <div class="flex items-center gap-4">
        <!-- Icon / Avatar Placeholder -->
        <div
          class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary shrink-0"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-5 h-5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
            />
          </svg>
        </div>

        <!-- Main Info -->
        <div class="flex flex-col">
          <span class="font-bold text-secondary text-base leading-tight">
            {{ item[headers[0].value] }}
          </span>
          @if(headers.length > 1) {
          <span class="text-xs text-tertiary mt-0.5">
            {{ headers[1].header }}: {{ item[headers[1].value] }}
          </span>
          }
        </div>
      </div>

      <!-- Expand/Collapse Chevron -->
      <div
        class="text-tertiary transition-transform duration-300"
        [class.rotate-180]="item.isVisible"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19.5 8.25l-7.5 7.5-7.5-7.5"
          />
        </svg>
      </div>
    </div>

    <!-- Expanded Details -->
    @if (item.isVisible) {
    <div class="mt-4 pt-4 border-t border-gray-100 animate-fade-in-down">
      <!-- Metadata Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        @for (header of headers; track header) { @if (header.value !==
        headers[0].value && header.value !== headers[1].value && header.value
        !== 'actions') {
        <div class="flex flex-col">
          <span
            class="text-xs font-medium text-tertiary uppercase tracking-wider mb-1"
          >
            {{ header.header }}
          </span>
          <span
            class="text-sm text-secondary font-medium dark:text-gray-200"
          >
            @if(header.value === 'appSecret') { ******** } 
            @else if(header.value === 'isActive') {
              <span
                class="inline-flex px-2 py-1 rounded-full text-xs font-medium"
                [ngClass]="
                  item.isActive
                    ? 'bg-green-100 text-green-800'
                    : 'bg-gray-100 text-gray-600'
                "
              >
                {{ item.isActive ? 'Activo' : 'Inactivo' }}
              </span>
            }
            @else if(header.value === 'status') {
              @if(item.status === 'pending' || item.status === 'PENDING') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs font-medium"
                  title="Factura pendiente de aprobación"
                >
                  Pendiente
                </span>
              } @else if(item.status === 'approved' || item.status === 'APPROVED') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs font-medium"
                  title="Factura aprobada"
                >
                  Aprobada
                </span>
              } @else if(item.status === 'rejected' || item.status === 'REJECTED') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-medium"
                  title="Factura rechazada"
                >
                  Rechazada
                </span>
              } @else if(item.status === 'sunat_valid' || item.status === 'VALIDO_ACEPTADO') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-primary/10 text-primary text-xs font-medium"
                  title="Factura Válida y emitida a la empresa"
                >
                  Válida
                </span>
              } @else if(item.status === 'sunat_valid_not_ours' || item.status === 'VALIDO_NO_PERTENECE') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-amber-100 text-amber-800 text-xs font-medium"
                  title="Factura válida pero no ha sido emitida a la empresa"
                >
                  Válida, Externa
                </span>
              } @else if(item.status === 'sunat_error' || item.status === 'ERROR_SUNAT') {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-medium"
                  title="Error en el servicio de sunat"
                >
                  Rechazada
                </span>
              } @else {
                <span
                  class="inline-flex px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs font-medium"
                >
                  {{ item[header.value] || 'Pendiente' }}
                </span>
              }
            }
            @else if(isDateField(header.value) && isValidDate(item[header.value])) {
            {{ formatDate(item[header.value]) }}
            } @else if(isTotalField(header.value) && isNumber(item[header.value])) {
            {{ item[header.value] | currency:'PEN':'symbol' }}
            } @else if(isTotalField(header.value)) {
            {{ item[header.value] }}
            } @else {
            {{ item[header.value] || '—' }}
            }
          </span>
        </div>
        } }
      </div>

      <!-- Actions Bar -->
      @for (header of headers; track header) { @if (header.value ===
      'actions') {
      <div
        class="flex items-center gap-3 mt-2 overflow-x-auto py-2 no-scrollbar"
      >
        @for (option of header.options; track option) { @if (option ===
        'edit') {
        <button
          (click)="clickOptions('edit', item._id)"
          class="flex-1 min-w-[100px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-blue-50 text-blue-600 font-medium text-sm hover:bg-blue-100 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
            />
          </svg>
          Editar
        </button>
        } @if (option === 'delete') {
        <button
          (click)="clickOptions('delete', item._id)"
          class="flex-1 min-w-[100px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-50 text-red-600 font-medium text-sm hover:bg-red-100 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
              clip-rule="evenodd"
            />
          </svg>
          Borrar
        </button>
        } @if (option === 'download') {
        <button
          (click)="clickOptions('download', item._id)"
          class="flex-1 min-w-[40px] h-[40px] flex items-center justify-center rounded-lg bg-gray-50 text-secondary hover:bg-gray-100 transition-colors"
          title="Descargar"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-5 h-5"
          >
            <path
              fill-rule="evenodd"
              d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
        } @if (option === 'approve' && item.status !== 'approved' &&
        item.status !== 'APPROVED') {
        <button
          (click)="clickOptions('approve', item._id)"
          class="flex-1 min-w-[100px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-green-50 text-green-600 font-medium text-sm hover:bg-green-100 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd"
            />
          </svg>
          Aprobar
        </button>
        } @if (option === 'reject' && item.status !== 'rejected' &&
        item.status !== 'REJECTED') {
        <button
          (click)="clickOptions('reject', item._id)"
          class="flex-1 min-w-[100px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-50 text-red-600 font-medium text-sm hover:bg-red-100 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
          Rechazar
        </button>
        } @if (option === 'activate') {
        <button
          (click)="clickOptions('activate', item._id)"
          class="flex-1 min-w-[120px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-amber-50 text-amber-700 font-medium text-sm hover:bg-amber-100 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-5.414V7a1 1 0 112 0v5.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L9 12.586z"
              clip-rule="evenodd"
            />
          </svg>
          {{ item.isActive ? 'Desactivar' : 'Activar' }}
        </button>
        } @if (option === 'view') {
        <button
          (click)="clickOptions('view', item._id)"
          class="flex-1 min-w-[100px] flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary/5 text-primary font-medium text-sm hover:bg-primary/10 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12 5c-7.633 0-10 7-10 7s2.367 7 10 7 10-7 10-7-2.367-7-10-7Zm0 11.25A4.25 4.25 0 1 1 12 8.75a4.25 4.25 0 0 1 0 8.5Z"
            />
            <path
              d="M12 10.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z"
            />
          </svg>
          Ver
        </button>
        } }
      </div>
      } }
    </div>
    }
  </div>
  }
</div>
